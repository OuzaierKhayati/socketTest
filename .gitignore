
/node_modules
client/node_modules/
server/node_modules/


import React, { useContext, useEffect,useRef, useState } from "react";
import { SocketContext } from "../socketContext";

function Chat() {
    const socket = useContext(SocketContext);
    const [message, setMessage] = useState({ msg: "" });
    const [allMessages, setAllMessages] = useState([]);
    const [myId, setMyId] = useState(localStorage.getItem('myId') || "");

    const inputRef = useRef(null);

    // Get the socket ID when the component mounts
    useEffect(() => {
        socket.on("tranID", (id) => {
            setMyId(id);
            localStorage.setItem('myId', id);
            // console.log(id);
        });

        socket.emit("getMessages", {}, (data) => {
            setAllMessages(data);
        });

        // Clean up the socket event when the component unmounts
        return () => {
            socket.off("tranID");
            socket.off("allMessages");
        };
    }, [socket]);

    function handleInput(event) {
        let { name, value } = event.target;
        setMessage((prevMessage) => ({
            ...prevMessage,
            [name]: value,
        }));
    }

    function send() {
        if (message.msg) {
            socket.emit("messages", message);
            setMessage({ msg: "" });
            inputRef.current.focus();
        }
    }

    useEffect(() => {
        socket.on("allMessages", (data) => {
            setAllMessages(data);
        });

        return () => { socket.off("allMessages"); }
    }, [socket]);

    return (
        <>
            <div className="chatBox">
                { allMessages.length > 1 ? (
                    allMessages.map((allMessage, index) => (
                        <p
                            key={index}
                            className={
                                allMessage.id === myId
                                    ? "message-right"
                                    : "message-left"
                            }
                        >
                            {allMessage.msg}
                        </p>
                    ))
                ):( 
                    (allMessages.length > 0 && (
                        allMessages[0].id === myId ?
                            <p className="message-right">
                                {allMessages[0].msg}
                            </p>
                        :
                            <p className="message-left">
                                {allMessages[0].msg}
                            </p>
                        )
                    )
                )}
            </div>
            <input 
                className="input-field"
                name="msg" 
                placeholder="Type your message" 
                onChange={handleInput} 
                value={message.msg}
                ref={inputRef} 
            />
            <button onClick={send}>Send</button>
        </>
    );
}

export default Chat;
